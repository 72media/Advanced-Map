<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Advanced Map with HTML Support in Marker Details</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet CSS and Plugins -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <!-- MarkerCluster CSS for grouping markers -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }

    .leaflet-popup-content {
      max-width: 640px !important;
      max-height: 500px;
      overflow-y: auto;
    }

    .leaflet-popup-content iframe {
      width: 100% !important;
      height: auto !important;
      aspect-ratio: 16 / 9;
      border: none;
    }
    
    /* Style for the video player */
    .leaflet-popup-content video {
      width: 100% !important;
      height: auto !important;
      background-color: #000;
    }

    .marker-content {
      margin-top: 10px;
    }

    .controls {
      position: absolute;
      top: 10px;
      left: 10.5%;
      transform: translateX(-50%);
      background: white;
      color: black;
      z-index: 1000;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      max-width: 200px;
      text-align: center;
    }
    
    .controls label, .controls input, .controls button {
      display: block;
      margin-top: 5px;
      width: 100%;
    }

    .toggle-btn {
      position: absolute;
      top: 10px;
      left: 55px;
      z-index: 1100;
      padding: 5px 10px;
      background: white;
      color: black;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: white;
      color: black;
      padding: 20px;
      border-radius: 10px;
      width: 400px;
      max-width: 90%;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    .modal-content h2 {
      margin-top: 0;
    }

    .modal-content input,
    .modal-content textarea {
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    .modal-content button {
      padding: 8px 15px;
      margin-right: 10px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .html-hint {
      font-size: 0.8em;
      color: #666;
      margin-bottom: 10px;
    }
    .hidden {
      display: none;
    }
    .full-screen-btn {
        display: block;
        margin: 10px auto 0 auto;
        padding: 8px 15px;
        background-color: transparent; /* Remove background */
        color: white; /* White text */
        font-size: 1.2em; /* Larger font size */
        text-decoration: none;
        border-radius: 4px;
        text-align: center;
        font-weight: bold;
    }
    
    /* Toast Notification styles */
    .toast-container {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 3000;
      display: flex;
      flex-direction: column-reverse;
      align-items: center;
    }
    .toast {
      background-color: #333;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      margin-top: 10px;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }
    .toast.show {
      opacity: 1;
    }
  </style>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.5/purify.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-omnivore/0.3.4/leaflet-omnivore.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <!-- MarkerCluster JS for grouping markers -->
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
</head>
<body>

<button class="toggle-btn" onclick="toggleControls()">‚ò∞</button>
<div class="controls" id="toolbox">
  <h3>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</h3>
  <label>üìÇ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
    <input type="file" id="file" accept=".geojson,.json,.kml,.gpx" />
  </label>
  <p class="html-hint">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö .geojson, .kml, .gpx</p>
  <label for="opacity-slider">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏∂‡∏ö‡πÅ‡∏™‡∏á‡∏Ç‡∏≠‡∏á‡∏†‡∏≤‡∏û‡∏ã‡πâ‡∏≠‡∏ô</label>
  <input type="range" id="opacity-slider" min="0" max="1" step="0.05" value="1" />
  <button id="saveGeoJSON">üíæ Export to GeoJSON</button>
  <button id="clear">üßπ Clear All</button>
  <button id="reset">üîÑ Reset View</button>
</div>

<div id="map"></div>

<!-- Modal to add marker details -->
<div class="modal" id="markerModal">
  <div class="modal-content">
    <h2>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Marker</h2>
    <label for="markerTitle">‡∏ä‡∏∑‡πà‡∏≠:</label>
    <input type="text" id="markerTitle" placeholder="‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠" />
    
    <label for="markerDesc">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</label>
    <textarea id="markerDesc" placeholder='‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡πÉ‡∏ä‡πâ HTML ‡πÑ‡∏î‡πâ)' rows="6"></textarea>
    <p class="html-hint">‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏ó‡∏£‡∏Å HTML ‡πÑ‡∏î‡πâ ‡πÄ‡∏ä‡πà‡∏ô iframe ‡∏à‡∏≤‡∏Å Google Drive ‡∏´‡∏£‡∏∑‡∏≠ YouTube</p>
    
    <button onclick="saveMarkerDetails()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    <button onclick="cancelMarkerDetails()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
  </div>
</div>

<!-- Modal to confirm clearing all layers -->
<div class="modal" id="clearConfirmModal">
  <div class="modal-content">
    <h2>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
    <p>‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏∏‡∏Å‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞ Marker ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?</p>
    <button onclick="confirmClear()">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    <button onclick="cancelClear()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
  </div>
</div>

<!-- Container for toast notifications -->
<div id="toast-container" class="toast-container"></div>

<script>
const defaultView = [13.736717, 100.523186];
const map = L.map('map').setView(defaultView, 6);

// Set up base tile layer
L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
  maxZoom: 19
}).addTo(map);

// Use a MarkerClusterGroup for markers to improve performance
const markers = L.markerClusterGroup();
map.addLayer(markers);

const drawnItems = new L.FeatureGroup().addTo(map);
let imageOverlay = null; // Store the image overlay layer

// Initialize the draw control for creating new shapes and markers
const drawControl = new L.Control.Draw({
  edit: { featureGroup: drawnItems },
  draw: { marker: true, polyline: true, polygon: true, circle: true, rectangle: true }
});
map.addControl(drawControl);

let currentLayer = null;

// Handle the creation of new layers
map.on(L.Draw.Event.CREATED, function (e) {
  const layer = e.layer;
  if (e.layerType === 'marker') {
    currentLayer = layer;
    showMarkerModal();
  } else {
    // Add other shapes directly to the drawnItems layer group
    drawnItems.addLayer(layer);
  }
});

// Function to show a toast notification
function showToast(message, duration = 3000) {
  const toastContainer = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.textContent = message;
  toastContainer.appendChild(toast);
  
  // Show toast with a slight delay
  setTimeout(() => toast.classList.add('show'), 10);
  
  // Hide toast after a duration
  setTimeout(() => {
    toast.classList.remove('show');
    // Remove toast from DOM after it fades out
    setTimeout(() => toast.remove(), 500); 
  }, duration);
}

// Function to show the marker details modal
function showMarkerModal() {
  document.getElementById('markerModal').style.display = 'flex';
  document.getElementById('markerTitle').value = '';
  document.getElementById('markerDesc').value = '';
}

// Function to save marker details and add to map
function saveMarkerDetails() {
  if (!currentLayer) return;
  const title = document.getElementById('markerTitle').value || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠';
  const desc = document.getElementById('markerDesc').value || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î';

  const cleanDesc = DOMPurify.sanitize(desc, {
    ALLOWED_TAGS: ['a', 'p', 'div', 'br', 'iframe', 'img', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'strong', 'em', 'ul', 'ol', 'li'],
    ALLOWED_ATTR: ['href', 'src', 'width', 'height', 'frameborder', 'allowfullscreen', 'target', 'style', 'allow']
  });
  
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = cleanDesc;
  const iframe = tempDiv.querySelector('iframe');
  let youtubeUrl = null;
  if (iframe) {
    const src = iframe.getAttribute('src');
    if (src && src.includes('youtube.com/embed')) {
      youtubeUrl = src;
    }
  }

  let fullScreenButton = '';
  if (youtubeUrl) {
    fullScreenButton = `<br><br><a href="${youtubeUrl}" target="_blank" style="display: inline-block; padding: 8px 15px; background-color: transparent; color: white; text-decoration: none; border-radius: 4px;">‡∏î‡∏π‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠</a>`;
  }
  
  const popupContent = `
    <div style="max-width:640px;">
      <b>${title}</b><br>
      <div class="marker-content">${cleanDesc}${fullScreenButton}</div>
    </div>
  `;

  currentLayer.bindPopup(popupContent, {
    maxWidth: 660,
    minWidth: 320
  });

  markers.addLayer(currentLayer); // Add marker to the cluster group
  document.getElementById('markerModal').style.display = 'none';
  currentLayer = null;
}

// Function to cancel marker creation
function cancelMarkerDetails() {
  document.getElementById('markerModal').style.display = 'none';
  if (currentLayer) {
    map.removeLayer(currentLayer);
  }
  currentLayer = null;
}

// Function to toggle the visibility of the control panel
function toggleControls() {
  document.getElementById('toolbox').classList.toggle('hidden');
}

// Show clear confirmation modal instead of using confirm()
document.getElementById('clear').addEventListener('click', () => {
  document.getElementById('clearConfirmModal').style.display = 'flex';
});

// Function to handle the "Clear" button in the confirmation modal
function confirmClear() {
  drawnItems.clearLayers();
  markers.clearLayers();
  if (imageOverlay) {
    map.removeLayer(imageOverlay);
    imageOverlay = null;
  }
  document.getElementById('clearConfirmModal').style.display = 'none';
  showToast('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß');
}

// Function to handle the "Cancel" button in the confirmation modal
function cancelClear() {
  document.getElementById('clearConfirmModal').style.display = 'none';
}

// Reset map view to the default location and zoom level
document.getElementById('reset').addEventListener('click', () => {
  map.setView(defaultView, 6);
  showToast('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß');
});

// New code for file upload
document.getElementById('file').addEventListener('change', function (e) {
  const file = e.target.files[0];
  if (!file) {
    return;
  }

  const reader = new FileReader();
  reader.onload = function (event) {
    const content = event.target.result;
    const extension = file.name.split('.').pop().toLowerCase();

    // Check for KML files with a GroundOverlay
    if (extension === 'kml' && content.includes('<GroundOverlay>')) {
      try {
        const parser = new DOMParser();
        const kmlDoc = parser.parseFromString(content, 'text/xml');
        const groundOverlays = kmlDoc.querySelectorAll('GroundOverlay');

        groundOverlays.forEach(overlay => {
          const latLonBox = overlay.querySelector('LatLonBox');
          const href = overlay.querySelector('Icon href');
          
          if (latLonBox && href) {
            const north = parseFloat(latLonBox.querySelector('north').textContent);
            const south = parseFloat(latLonBox.querySelector('south').textContent);
            const east = parseFloat(latLonBox.querySelector('east').textContent);
            const west = parseFloat(latLonBox.querySelector('west').textContent);
            const imageUrl = href.textContent;
            
            const bounds = [[south, west], [north, east]];
            
            if (imageOverlay) {
              map.removeLayer(imageOverlay);
            }
            
            imageOverlay = L.imageOverlay(imageUrl, bounds, { opacity: parseFloat(document.getElementById('opacity-slider').value) }).addTo(map);
            map.fitBounds(bounds);
            showToast('‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡∏ã‡πâ‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå KML ‡πÅ‡∏•‡πâ‡∏ß');
          }
        });
      } catch (error) {
        showToast(`Error parsing KML GroundOverlay file: ${error.message}`, 5000);
        return;
      }
    }
    
    // Use omnivore for all other KML features, GeoJSON, and GPX
    let layer;
    try {
      if (extension === 'geojson' || extension === 'json') {
        layer = L.geoJSON(JSON.parse(content));
      } else if (extension === 'kml') {
        layer = omnivore.kml.parse(content);
      } else if (extension === 'gpx') {
        layer = omnivore.gpx.parse(content);
      }
    } catch (error) {
      showToast(`Error parsing file: ${error.message}`, 5000);
      return;
    }
    
    if (layer) {
      layer.eachLayer(function(l) {
        if (l instanceof L.Marker) {
          markers.addLayer(l); // Add markers to the cluster group
          setupPopup(l, l.feature.properties);
        } else {
          drawnItems.addLayer(l); // Add other shapes to the drawn items group
          setupPopup(l, l.feature.properties);
        }
      });
      
      const bounds = layer.getBounds();
      if (bounds.isValid()) {
        map.fitBounds(bounds);
      } else {
        showToast('‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏ó‡∏≤‡∏á‡∏†‡∏π‡∏°‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 5000);
      }
      showToast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡πâ‡∏ß');
    } else {
      showToast('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!', 5000);
    }
  };

  reader.readAsText(file);
});

// Function to set up the popup for a given layer
function setupPopup(layer, properties) {
  if (properties) {
    let popupContent = "";
    const description = properties.description || '';
    const m3u8UrlMatch = description.match(/(https?:\/\/[^\s]+\.m3u8)/);

    if (properties.name) {
      popupContent += `<b>${properties.name}</b><br>`;
    }

    if (m3u8UrlMatch) {
      const m3u8Url = m3u8UrlMatch[0];
      popupContent += `
        <div class="marker-content">
          <video id="hls-video-${L.stamp(layer)}" class="hls-video-player" controls muted></video>
          <a href="${m3u8Url}" target="_blank" class="full-screen-btn">‡∏î‡∏π‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠</a>
        </div>
      `;
      layer.on('popupopen', function() {
        const video = document.getElementById(`hls-video-${L.stamp(layer)}`);
        if (Hls.isSupported() && video) {
          var hls = new Hls();
          hls.loadSource(m3u8Url);
          hls.attachMedia(video);
          hls.on(Hls.Events.MANIFEST_PARSED, function() {
            video.play();
          });
        } else if (video && video.canPlayType('application/vnd.apple.mpegurl')) {
          video.src = m3u8Url;
          video.addEventListener('loadedmetadata', function() {
            video.play();
          });
        }
      });
    } else if (description) {
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = description;
      const iframe = tempDiv.querySelector('iframe');
      let fullScreenButton = '';
      if (iframe) {
        const src = iframe.getAttribute('src');
        if (src && src.includes('youtube.com/embed')) {
          fullScreenButton = `<br><br><a href="${src}" target="_blank" style="display: inline-block; padding: 8px 15px; background-color: transparent; color: white; text-decoration: none; border-radius: 4px;">‡∏î‡∏π‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠</a>`;
        }
      }
      popupContent += `<div class="marker-content">${description}${fullScreenButton}</div>`;
    }
    
    if (popupContent) {
      layer.bindPopup(popupContent, {
        maxWidth: 660,
        minWidth: 320
      });
    }
  }
}

// Event listener for the opacity slider
document.getElementById('opacity-slider').addEventListener('input', (e) => {
  const opacity = e.target.value;
  if (imageOverlay) {
    imageOverlay.setOpacity(opacity);
  }
});
</script>

</body>
</html>
